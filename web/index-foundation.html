<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Stackdigest</title>

  <link rel="stylesheet" href="foundation/css/normalize.css" />
  <link rel="stylesheet" href="foundation/css/foundation.css" />
  <link rel="stylesheet" href="foundation/css/aldrin.css" />
  <script type='text/javascript' src='jquery-1.8.2.min.js'></script>
  <script src="foundation/js/vendor/custom.modernizr.js"></script>
  <script type='text/javascript' src='js3rdparty/sockjs-0.2.1.min.js'></script>
  <script type='text/javascript' src='js/vertxbus.js'></script>
  <script type='text/javascript' src='js/jquery.cookie.js'></script>
  <script type='text/javascript' src='js/knockout-2.2.1.js'></script>


</head>
<body>
    <header class="row">
        <div class="large-8 columns">
            <h2>Stackdigest</h2>
        </div>
        <div class="large-4 columns profile" hidden>
            <a class="th radius">
                <span class="displayName"></span>
                <img/>
            </a>
        </div>
    </header>

    <div id="not-signedin" hidden>
        <div class="row">
            <div class="large-4 large-centered columns">
                <a href="" class="button radius round secondary signin">Sign in with <img width="20px" src="img/stackexchange.png"> StackExchange</a>
            </div>
        </div>

        <div class="row">
            <div class="large-8 large-centered columns">
                <h5>
                    <ul>
                        <li>
                            monitor your favorite questions at all StackExchange sites
                        </li>
                        <li>
                            receive updates via email
                        </li>
                    </ul>
                </h5>
            </div>
        </div>

        <div class="row">
            <div class="large-12 columns large-centered text-center">
                <small>Missed the huge sign in button at the top? here's another one...</small>
            </div>
        </div>

        <div class="row">
            <div class="large-4 large-centered columns">
                <a href="" class="button radius round secondary signin">Sign in with <img width="20px" src="img/stackexchange.png"> StackExchange</a>
            </div>
        </div>
    </div>

    <div id="signed-in">
        <div class="row">
            <table>
                <caption>Your StackExchange sites</caption>
                <thead>
                <tr>
                    <th width="400"></th>
                    <th></th>
                    <th width="450"></th>
                </tr>
                </thead>
                <tbody data-bind="foreach: sites">
                <tr>
                    <td data-bind="text: name"></td>
                    <td data-bind="text: totalFavs"></td>
                    <td>Stop Watching</td>
                </tr>
                </tbody>
            </table>


        </div>

    </div>

    <footer class="row">
        <div class="large-12 large-centered columns">
            <h6><small>Besides the use of the StackExchange API, this site is in no way affiliated with <a href="http://stackexchange.com/">StackExchange</a>.
                All trademarks and copyrights acknowledged. Copyright &copy; Aldrin Misquitta</small></h6>
        </div>
    </footer>

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'foundation/js/vendor/zepto' : 'foundation/js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="foundation/js/foundation.min.js"></script>
  <!--
  
  <script src="js/foundation/foundation.js"></script>
  
  <script src="js/foundation/foundation.dropdown.js"></script>
  
  <script src="js/foundation/foundation.alerts.js"></script>
  
  <script src="js/foundation/foundation.clearing.js"></script>
  
  <script src="js/foundation/foundation.placeholder.js"></script>
  
  <script src="js/foundation/foundation.forms.js"></script>
  
  <script src="js/foundation/foundation.cookie.js"></script>
  
  <script src="js/foundation/foundation.joyride.js"></script>
  
  <script src="js/foundation/foundation.magellan.js"></script>
  
  <script src="js/foundation/foundation.orbit.js"></script>
  
  <script src="js/foundation/foundation.reveal.js"></script>
  
  <script src="js/foundation/foundation.section.js"></script>
  
  <script src="js/foundation/foundation.tooltips.js"></script>
  
  <script src="js/foundation/foundation.topbar.js"></script>
  
  -->
  
  <script>
    $(document).foundation();
    var eb = new vertx.EventBus(window.location.protocol + '//' + window.location.hostname + ':' + window.location.port + '/eventbus');

    var theModel = new SiteViewModel();
      function Site(name, totalFavs) {
      var self = this;
      self.name = name;
      self.totalFavs = totalFavs;
      }

      function SiteViewModel() {
          var self = this;

          self.sites = ko.observableArray();
      }

      $(function() {
      function profileUpdate(profile) {
        $('.profile a').attr('href', 'https://stackexchange.com/users/'+profile.accountId);
        $('.profile span').text(profile.displayName);
        $('.profile img').attr('src', profile.profileImage);
        $('.profile').fadeIn();
      }

      var sink = function(message) {
          console.log('I received a message :: ');
          console.log(message);
          console.log('---EOM---');
          switch (message.action) {
              case 'profileUpdate':
                  profileUpdate(message.payload);
                  break;

              case 'authSession':
                if (message.payload.status == 'ok') {
                    //use knockout ya
                    $('#not-signedin').hide();
                    $('#signed-in').show();
                    console.log('OK GOOD TO GO');
                }
                else if (message.payload.status == 'denied') {
                    $('#not-signedin').show();
                    $('#signed-in').hide();
                    $.removeCookie('sessionId');
                }
                break

              case 'updateSites' :
                console.log('in updte sites');
                console.log(message.payload);
                $.each(message.payload.siteDetails,
                        function(ind, val) {
                            console.log(val);
                            theModel.sites.push(new Site(val.name, val.totalFavs))
                        });
                break;
          }
      }

      eb.onopen = function() {
        eb.registerHandler('frontend', sink);
        initStuff();
      };

      function initStuff() {
        eb.send('restService', {action: 'oauthConfig'},
            function (oauthConfig) {
                console.log(oauthConfig);
                var oUrl = oauthConfig.oAuthUrl
                if (oUrl) {
                  $('a.signin').bind('click', function() {
                    $(this).attr('href', oUrl);
                  });
                }
                else {
                  console.error('Failed to retrieve oAuthConfig');
                }
            }
        );

        eb.send('restService', {action: 'auth-session', payload: {sessionId: $.cookie('sessionId')}},
            function(message) {
                console.log(message);
            }
        );

        ko.applyBindings(theModel);

      };



    });
  </script>
</body>
</html>
